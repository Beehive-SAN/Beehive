<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOF2 LOBBY</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            overflow: hidden;
        }

        .centered-box {
            width: 80vw;
            height: 80vh;
            border: 2px solid #333;
            padding: 20px;
            text-align: center;
            background-color: #fff;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.2);
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }

        .bubble-button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
        }

        .bubble {
            position: absolute;
            background-color: rgba(173, 216, 230, 0.7);
            border-radius: 50%;
            opacity: 0;
            transform: scale(0.2);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 16px;
            color: #333;
            font-weight: bold;
            transition: opacity 0.5s;
            cursor: pointer; /* 클릭 가능하도록 커서 변경 */
        }

        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.2);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
            }
        }
    </style>
</head>
<body>
    <div class="centered-box">
        <button class="bubble-button">물방울 생성</button>
    </div>

    <script>
        // 상수 정의 (가독성 및 유지보수성 향상)
        const BUBBLE_SIZE = 100; // 물방울 크기 (px)
        const TOTAL_LIFETIME_MS = 5 * 60 * 1000; // 물방울 총 생명 주기 (5분)
        const FADE_OUT_DURATION_MS = 5 * 1000; // 물방울 사라지는 시간 (5초)
        const MAX_PLACEMENT_ATTEMPTS = 100; // 물방울 배치 시도 최대 횟수
        const BOX_PADDING = 20; // centered-box의 padding 값 (px)

        const activeBubbles = []; // 현재 활성화된 물방울들을 저장하는 배열

        document.querySelector('.bubble-button').addEventListener('click', function() {
            const centeredBox = document.querySelector('.centered-box');
            
            // 물방울이 배치될 수 있는 최대 x, y 좌표 (패딩 고려)
            const maxX = centeredBox.offsetWidth - BUBBLE_SIZE - 2 * BOX_PADDING;
            const maxY = centeredBox.offsetHeight - BUBBLE_SIZE - 2 * BOX_PADDING;

            let startX, startY;
            let foundPosition = false;
            let attempts = 0;

            // 물방울이 겹치지 않는 위치를 찾을 때까지 반복
            while (!foundPosition && attempts < MAX_PLACEMENT_ATTEMPTS) {
                // 랜덤 위치 계산
                startX = Math.random() * maxX + BOX_PADDING;
                startY = Math.random() * maxY + BOX_PADDING;

                let overlapping = false;
                for (const existingBubble of activeBubbles) {
                    // 기존 물방울의 현재 위치 가져오기 (relative to centeredBox)
                    const existingLeft = parseFloat(existingBubble.style.left);
                    const existingTop = parseFloat(existingBubble.style.top);

                    // 두 물방울 중심점 간의 거리 계산
                    const distanceX = (startX + BUBBLE_SIZE / 2) - (existingLeft + BUBBLE_SIZE / 2);
                    const distanceY = (startY + BUBBLE_SIZE / 2) - (existingTop + BUBBLE_SIZE / 2);
                    const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);

                    // 두 물방울이 겹치지 않기 위한 최소 거리 (두 반지름의 합)
                    const minDistance = BUBBLE_SIZE; // (BUBBLE_SIZE / 2) + (BUBBLE_SIZE / 2)

                    if (distance < minDistance) {
                        overlapping = true;
                        break;
                    }
                }

                if (!overlapping) {
                    foundPosition = true;
                }
                attempts++;
            }

            // 적절한 위치를 찾지 못했으면 물방울 생성 중단
            if (!foundPosition) {
                console.warn("겹치지 않는 위치를 찾지 못했습니다. 물방울 생성을 중단합니다.");
                return;
            }

            const bubble = document.createElement('div');
            bubble.classList.add('bubble');
            bubble.style.width = `${BUBBLE_SIZE}px`;
            bubble.style.height = `${BUBBLE_SIZE}px`;
            bubble.style.left = `${startX}px`;
            bubble.style.top = `${startY}px`;

            const countdownText = document.createElement('span');
            bubble.appendChild(countdownText);

            centeredBox.appendChild(bubble);
            activeBubbles.push(bubble); // 생성된 물방울을 배열에 추가

            // 물방울 나타나는 애니메이션 적용
            bubble.style.animation = 'fadeInScale 0.5s forwards';

            const fadeOutStartTime = TOTAL_LIFETIME_MS - FADE_OUT_DURATION_MS;
            let remainingTime = TOTAL_LIFETIME_MS;
            let countdownInterval; // setInterval ID를 저장할 변수

            const updateCountdown = () => {
                const minutes = Math.floor(remainingTime / (60 * 1000));
                const seconds = Math.floor((remainingTime % (60 * 1000)) / 1000);
                countdownText.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                remainingTime -= 1000;

                if (remainingTime < 0) {
                    clearInterval(countdownInterval);
                }
            };

            updateCountdown(); // 초기 카운트다운 표시
            countdownInterval = setInterval(updateCountdown, 1000); // interval ID를 변수에 할당

            // 물방울 사라지는 애니메이션 시작 시점
            const timeoutIdFadeOut = setTimeout(() => {
                // 물방울이 아직 DOM에 있다면 애니메이션 적용
                if (bubble.parentNode) {
                    bubble.style.animation = `fadeOut ${FADE_OUT_DURATION_MS / 1000}s forwards`;
                    clearInterval(countdownInterval); // 카운트다운 중지
                }
            }, fadeOutStartTime);

            // 물방울 완전히 제거
            const timeoutIdRemove = setTimeout(() => {
                if (bubble.parentNode) {
                    bubble.remove(); // DOM에서 물방울 제거
                    // activeBubbles 배열에서 물방울 제거
                    const index = activeBubbles.indexOf(bubble);
                    if (index > -1) {
                        activeBubbles.splice(index, 1);
                    }
                }
            }, TOTAL_LIFETIME_MS);

            // 물방울 클릭 시 사라지게 하는 이벤트 리스너 추가
            bubble.addEventListener('click', function() {
                // 클릭 시 바로 사라지는 애니메이션 적용 (선택 사항: 원하면 fadeOut 애니메이션을 적용할 수 있음)
                bubble.style.animation = `fadeOut 0.3s forwards`; // 0.3초 동안 빠르게 사라지도록 설정
                clearInterval(countdownInterval); // 카운트다운 중지
                clearTimeout(timeoutIdFadeOut); // 예정된 fadeOut 타이머 취소
                clearTimeout(timeoutIdRemove); // 예정된 remove 타이머 취소

                // 애니메이션 종료 후 DOM에서 제거 및 배열에서 삭제
                bubble.addEventListener('animationend', function() {
                    if (bubble.parentNode) {
                        bubble.remove();
                        const index = activeBubbles.indexOf(bubble);
                        if (index > -1) {
                            activeBubbles.splice(index, 1);
                        }
                    }
                }, { once: true }); // 한 번만 실행되도록 { once: true } 옵션 사용
            });
        });
    </script>
</body>
</html>
